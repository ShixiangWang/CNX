---
title: "PART 5: Inference of copy number signature etiologiess"
author: ["Shixiang Wang, Ziyu Tao, Tao Wu, Xue-Song Liu (Corresponding author)"]
date: "`r Sys.Date()`"
output:
  rmdformats::downcute:
    self_contained: true
    toc_depth: 3
bibliography: ref.bib
link-citations: yes
---


```{r setup-05, include=FALSE}
library(knitr)
library(rmdformats)
## Global options
options(max.print = "75")
opts_chunk$set(
  echo = FALSE,
  cache = FALSE,
  prompt = FALSE,
  tidy = "styler",
  comment = NA,
  dpi = 300,
  message = FALSE,
  warning = FALSE,
  echo = TRUE
)
opts_knit$set(width = 75)
Sys.setenv("LANGUAGE" = "EN")
```

In this part, we would like to explore CN signatures in more details with association analysis and summarize what we get to infer their etiologies.

Let's merge load all data we got and combine them.

```{r message=FALSE}
library(tidyverse)
library(sigminer)

tidy_info <- readRDS("../data/pcawg_sample_tidy_info.rds")
tidy_anno <- readRDS("../data/pcawg_tidy_anno_df.rds")
tidy_mut <- readRDS("../data/pcawg_mut_df.rds")
pcawg_sbs <- read_csv("../data/PCAWG/PCAWG_sigProfiler_SBS_signatures_in_samples.csv")
pcawg_dbs <- read_csv("../data/PCAWG/PCAWG_sigProfiler_DBS_signatures_in_samples.csv")
pcawg_id <- read_csv("../data/PCAWG/PCAWG_SigProfiler_ID_signatures_in_samples.csv")
```

Merge data.

```{r}
df_merged <- purrr::reduce(
  list(
    tidy_info %>% 
      dplyr::filter(keep) %>% 
      dplyr::select(sample, starts_with("Abs"), starts_with("Rel")),
    tidy_anno %>%
      tibble::rownames_to_column("sample") %>% 
      dplyr::mutate(
        Tumor_Stage = dplyr::case_when(
          Tumor_Stage == "I" ~ 1,
          Tumor_Stage == "II" ~ 2,
          Tumor_Stage == "III" ~ 3,
          Tumor_Stage == "IV" ~ 4),
        isFemale = Sex == "female",
        isWGD = WGD_Status == "wgd",
        isHRD = HRD_Status == "hrd"
      ) %>% 
      dplyr::select(-c(Sex, WGD_Status, HRD_Status)),
    pcawg_sbs[, -c(1, 3)] %>% dplyr::rename(sample = `Sample Names`) %>% 
      # Drop Possible sequencing artefact associated signatures
      dplyr::select(-SBS43, -c(SBS45:SBS60)),
    pcawg_dbs[, -c(1, 3)] %>% dplyr::rename(sample = `Sample Names`),
    pcawg_id[, -c(1, 3)] %>% dplyr::rename(sample = `Sample Names`),
    tidy_mut %>% dplyr::select(-cluster)
  ),
  dplyr::left_join,
  by = "sample"
) %>% 
  dplyr::mutate_if(
    is.logical,
    ~ifelse(is.na(.), FALSE, .)
  )

colnames(df_merged) <- gsub("Abs_", "", colnames(df_merged))

saveRDS(df_merged, file = "../data/pcawg_merged_df.rds")
```

## Association analysis for copy number signatures

```{r}
pcawg_expo <- readRDS("../data/pcawg_cn_sigs_CN176_activity.rds")
keep_samples <- pcawg_expo$similarity >= 0.75
pcawg_expo$abs_activity <- pcawg_expo$abs_activity[keep_samples]
pcawg_expo$rel_activity <- pcawg_expo$rel_activity[keep_samples]
```

### Signature activity association

For absolute signature activity.

```{r}
show_cor(pcawg_expo$abs_activity[, -1])
```

For relative signature activity.

```{r}
show_cor(pcawg_expo$rel_activity[, -1])
```

### Signature clustering

We can take a try to cluster signatures based on their relative activities.

```{r}
expo_mat_rel <- pcawg_expo$rel_activity %>% 
  tibble::column_to_rownames("sample") %>% 
  as.matrix() %>% 
  t()

hc <- hclust(dist(expo_mat_rel))
```

```{r}
factoextra::fviz_dend(hc, k = 3, rect = T)
```

## Association between copy number signatures (CNS) and other types of signatures (SBS, DBS, ID)

### CNS and SBS

### CNS and DBS

### CNS and ID

## Signature similarity comparison between different types of signatures

> 比较不同 signature type 的平均相似性

## Signature association network construction and visualization

> Try to learn from NC paper

## Association between CNS and genotype/phenotype features

## Association between CNS and patients' prognosis

## Data summary and inference of signature etiologies
